<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Plan New Trip - BudgetTrip</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            height: 600px;
            width: 100%;
            border-radius: 0.5rem;
            border: 2px solid #e2e8f0;
            z-index: 1;
            background-color: #f0fdf4;
        }
        /* Custom styles for Leaflet popup */
        .leaflet-popup-content {
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }
        .hotel-popup .leaflet-popup-content { color: #d97706; }
        .activity-popup .leaflet-popup-content { color: #7c3aed; }

        /* Weather Widget Animation */
        .weather-box {
            transition: all 0.5s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .weather-box.visible {
            max-height: 200px;
            opacity: 1;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">

<div class="container mx-auto px-4">

    <div class="bg-white p-6 rounded-lg shadow-xl grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- LEFT SIDE: FORM -->
        <div class="lg:col-span-1 space-y-6">
            <div>
                <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                    <span>üìç</span> Plan Trip Route
                </h2>
                <p class="text-xs text-gray-500 mt-1">Search specific places (e.g., "NSBM", "Pizza Hut") or click map.</p>
            </div>

            <form th:action="@{/trips}" method="post" id="tripForm" onsubmit="return validateForm()">

                <!-- HIDDEN INPUT FOR DISTANCE -->
                <input type="hidden" id="distanceKm" name="distanceKm" value="0.0">

                <!-- Trip Name (Optional if you want it back, or auto-generated) -->
                <!-- <input type="hidden" name="name" value="My Trip"> -->

                <!-- Locations -->
                <div class="space-y-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1 uppercase">From (Start)</label>
                        <div class="flex items-center">
                            <span class="bg-green-500 w-3 h-3 rounded-full mr-2"></span>
                            <input type="text" id="startLocation" name="startLocation"
                                   class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                                   placeholder="e.g. Ibbagamuwa Central College" required
                                   onchange="manualLocationInput('start')">
                        </div>
                    </div>

                    <div class="border-l-2 border-dashed border-gray-300 h-4 ml-1.5"></div>

                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1 uppercase">To (Destination)</label>
                        <div class="flex items-center">
                            <span class="bg-red-500 w-3 h-3 rounded-full mr-2"></span>
                            <input type="text" id="endLocation" name="endLocation"
                                   class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                                   placeholder="e.g. NSBM Green University" required
                                   onchange="manualLocationInput('end')">
                        </div>
                    </div>

                    <!-- Weather Widget -->
                    <div id="weatherWidget" class="weather-box bg-white rounded-lg p-3 border border-blue-200 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img id="weatherIcon" src="" alt="Weather" class="w-10 h-10">
                            <div>
                                <p class="text-[10px] text-gray-500 font-bold uppercase">Destination Weather</p>
                                <p id="weatherTemp" class="text-xl font-bold text-gray-800 leading-none">--¬∞C</p>
                                <p id="weatherDesc" class="text-xs text-blue-600 font-medium">Loading...</p>
                            </div>
                        </div>
                        <div id="rainAlert" class="hidden text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-bold">
                            ‚òî Rainy!
                        </div>
                    </div>

                    <!-- Recommendations Checkbox -->
                    <div class="flex items-center mt-2">
                        <input id="findRecommendations" type="checkbox" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                        <label for="findRecommendations" class="ml-2 text-sm font-medium text-gray-900">Show Hotels & Activities on route üè®üì∑</label>
                    </div>

                    <!-- Distance Display -->
                    <div id="distanceBox" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-2 text-sm">
                        <p class="font-bold">Estimated Road Distance:</p>
                        <p id="distanceValue">Calculating...</p>
                    </div>
                </div>

                <!-- Dates -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Start Date</label>
                        <input type="date" id="startDate" name="startDate" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">End Date</label>
                        <input type="date" id="endDate" name="endDate" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                </div>

                <!-- Budget -->
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Total Budget (Rs.)</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">Rs.</span>
                        <input type="number" step="0.01" name="totalBudget"
                               class="pl-10 shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                               placeholder="50000" required>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-between gap-4 mt-8">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700 font-bold py-2 px-4 rounded w-1/3 text-center transition">
                        Cancel
                    </a>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg w-2/3 shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
                        Create Trip üöÄ
                    </button>
                </div>
            </form>
        </div>

        <!-- RIGHT SIDE: INTERACTIVE MAP -->
        <div class="lg:col-span-2 relative">
            <div id="map" class="shadow-inner"></div>

            <div class="absolute top-4 right-4 bg-white/90 backdrop-blur p-3 rounded-lg shadow-md z-[1000] text-xs max-w-xs border border-gray-200">
                <p class="font-bold text-gray-700 border-b pb-1 mb-1">How to use Map:</p>
                <ul class="list-none text-gray-600 space-y-1">
                    <li>üü¢ <b>Click 1:</b> Set Start Location</li>
                    <li>üî¥ <b>Click 2:</b> Set End Location</li>
                </ul>
                <button onclick="resetMap()" class="mt-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 rounded text-xs transition border border-gray-300">
                    ‚Ü∫ Reset Selection
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Added th:inline="none" to prevent parsing errors -->
<script th:inline="none">
    document.addEventListener('DOMContentLoaded', function() {
        // Set Min Date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("startDate").min = today;
        document.getElementById("endDate").min = today;

        // Initialize Map
        var map = L.map('map', {
            center: [7.8731, 80.7718],
            zoom: 8,
            minZoom: 7,
            maxBounds: [[5.8, 79.0], [10.0, 82.5]], // Arrays work fine now with th:inline="none"
            maxBoundsViscosity: 1.0
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Fix: Force map refresh to avoid gray screen
        setTimeout(function() {
            map.invalidateSize();
        }, 500);

        var selectionStep = 1;
        var startMarker = null;
        var endMarker = null;
        var routeLine = null;
        var recommendationMarkers = [];

        // Validation
        window.validateForm = function() {
            var dist = document.getElementById('distanceKm').value;
            if (!dist || dist === "0.0") {
                 if(startMarker && endMarker) {
                     var d = (startMarker.getLatLng().distanceTo(endMarker.getLatLng()) / 1000).toFixed(2);
                     document.getElementById('distanceKm').value = d;
                     return true;
                 }
                 document.getElementById('distanceKm').value = "0.0";
            }
            return true;
        }

        // --- Handle Specific Place Search (Restored Logic) ---
        window.manualLocationInput = function(type) {
            var inputId = type === 'start' ? 'startLocation' : 'endLocation';
            var query = document.getElementById(inputId).value;

            if (!query) return;

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=lk&addressdetails=1&limit=1`)
                .then(response => {
                    if(!response.ok) throw new Error("Network");
                    return response.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        var result = data[0];
                        var lat = parseFloat(result.lat);
                        var lon = parseFloat(result.lon);
                        var displayName = result.display_name;

                        var shortName = displayName.split(",")[0];
                        var city = result.address.city || result.address.town || result.address.village || result.address.state || "Sri Lanka";

                        document.getElementById(inputId).value = shortName + ", " + city;

                        if (type === 'start') {
                            if (startMarker) map.removeLayer(startMarker);
                            startMarker = L.marker([lat, lon], {icon: createIcon('green')}).addTo(map)
                                .bindPopup("<b>Start:</b> " + displayName).openPopup();
                            map.setView([lat, lon], 16);
                            selectionStep = 2;
                        } else {
                            if (endMarker) map.removeLayer(endMarker);
                            endMarker = L.marker([lat, lon], {icon: createIcon('red')}).addTo(map)
                                .bindPopup("<b>End:</b> " + displayName).openPopup();
                            map.setView([lat, lon], 16);
                            selectionStep = 1;

                            // *** WEATHER FETCH ADDED HERE ***
                            fetchWeather(lat, lon);
                        }
                        drawRouteAndCalculate();
                    } else {
                        alert("Place not found in Sri Lanka! Try adding more details.");
                    }
                })
                .catch(error => console.error("Error fetching location:", error));
        }

        // --- Handle Map Click (Restored Logic) ---
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            document.body.style.cursor = 'wait';

            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => {
                    if(!response.ok) throw new Error("Network");
                    return response.json();
                })
                .then(data => {
                    document.body.style.cursor = 'default';

                    var address = data.address;
                    var specificName = address.amenity || address.leisure || address.tourism || address.building || address.shop || address.office;
                    var cityName = address.city || address.town || address.village || address.suburb || "Unknown Location";
                    var locationName = specificName ? (specificName + ", " + cityName) : cityName;

                    if (selectionStep === 1) {
                        document.getElementById('startLocation').value = locationName;
                        if (startMarker) map.removeLayer(startMarker);
                        startMarker = L.marker([lat, lng], {icon: createIcon('green')}).addTo(map)
                            .bindPopup("<b>Start:</b> " + locationName).openPopup();
                        selectionStep = 2;
                    } else if (selectionStep === 2) {
                        document.getElementById('endLocation').value = locationName;
                        if (endMarker) map.removeLayer(endMarker);
                        endMarker = L.marker([lat, lng], {icon: createIcon('red')}).addTo(map)
                            .bindPopup("<b>End:</b> " + locationName).openPopup();
                        selectionStep = 1;

                        // *** WEATHER FETCH ADDED HERE ***
                        fetchWeather(lat, lng);
                    }
                    drawRouteAndCalculate();
                })
                .catch(error => {
                    document.body.style.cursor = 'default';
                    console.error('Error:', error);
                });
        });

        // --- Draw Route & Find Recommendations ---
        function drawRouteAndCalculate() {
            if (startMarker && endMarker) {
                var startLatLng = startMarker.getLatLng();
                var endLatLng = endMarker.getLatLng();

                document.getElementById('distanceBox').classList.remove('hidden');
                document.getElementById('distanceValue').innerText = "Finding route...";

                var url = `https://router.project-osrm.org/route/v1/driving/${startLatLng.lng},${startLatLng.lat};${endLatLng.lng},${endLatLng.lat}?overview=full&geometries=geojson`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                            var route = data.routes[0];
                            var distanceKm = (route.distance / 1000).toFixed(2);

                            document.getElementById('distanceValue').innerText = distanceKm + " km (Road Distance)";
                            document.getElementById('distanceKm').value = distanceKm;

                            if (routeLine) map.removeLayer(routeLine);

                            routeLine = L.geoJSON(route.geometry, {
                                style: { color: 'blue', weight: 5, opacity: 0.7 }
                            }).addTo(map);

                            map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});

                            // --- RECOMMENDATION LOGIC ---
                            if (document.getElementById('findRecommendations').checked) {
                                findRecommendationsOnRoute(route.geometry.coordinates);
                            }
                        } else {
                            var directDist = (startLatLng.distanceTo(endLatLng)/1000).toFixed(2);
                            document.getElementById('distanceValue').innerText = "Route not found! (Direct: " + directDist + " km)";
                            document.getElementById('distanceKm').value = directDist;
                            if (routeLine) map.removeLayer(routeLine);
                            routeLine = L.polyline([startLatLng, endLatLng], {color: 'red', dashArray: '5, 5'}).addTo(map);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        document.getElementById('distanceValue').innerText = "Error fetching route.";
                    });
            }
        }

        // --- Find Hotels AND Activities at Route Midpoint ---
        function findRecommendationsOnRoute(coordinates) {
            // Clear old markers
            recommendationMarkers.forEach(m => map.removeLayer(m));
            recommendationMarkers = [];

            // Pick a point roughly in the middle
            var midIndex = Math.floor(coordinates.length / 2);
            var midPoint = coordinates[midIndex]; // [lng, lat]
            var lat = midPoint[1];
            var lng = midPoint[0];

            // 1. Get the city/town name of the midpoint
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(res => res.json())
                .then(data => {
                    var city = data.address.city || data.address.town || data.address.village;
                    if (!city) city = "Sri Lanka";

                    // 2. Search for HOTELS
                    searchAndMark("hotels", city, 'gold', 'hotel-popup', "Est. Price", 5000, 20000);

                    // 3. Search for TOURIST ATTRACTIONS (Activities)
                    searchAndMark("tourism", city, 'violet', 'activity-popup', "Entry Fee", 500, 3000);
                })
                .catch(err => console.error("Rec Error", err));
        }

        function searchAndMark(query, city, iconColor, popupClass, costLabel, minCost, maxCost) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query} in ${city}&limit=3`)
                .then(res => res.json())
                .then(places => {
                    places.forEach(place => {
                        // Generate mock cost
                        var randomCost = Math.floor(Math.random() * (maxCost - minCost + 1)) + minCost;

                        var marker = L.marker([place.lat, place.lon], {icon: createIcon(iconColor)})
                            .addTo(map)
                            .bindPopup(`<b style="${iconColor === 'violet' ? 'color:#7c3aed' : 'color:#d97706'}">${place.display_name.split(",")[0]}</b><br>${costLabel}: Rs. ${randomCost}`, {
                                className: popupClass
                            });
                        recommendationMarkers.push(marker);
                    });
                })
                .catch(err => console.error("Search Error", err));
        }

        // --- Weather Function (Added Back) ---
        function fetchWeather(lat, lon) {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
                .then(res => {
                    if (!res.ok) throw new Error("Weather API response not ok");
                    return res.json();
                })
                .then(data => { if(data.current_weather) updateWeatherUI(data.current_weather); })
                .catch(err => console.error("Weather Fetch Error:", err));
        }

        function updateWeatherUI(weather) {
            document.getElementById('weatherWidget').classList.add('visible');
            document.getElementById('weatherTemp').innerText = `${weather.temperature}¬∞C`;
            var code = weather.weathercode;
            var desc = "Clear";
            var icon = "https://cdn-icons-png.flaticon.com/512/869/869869.png";
            var alertBox = document.getElementById('rainAlert');
            alertBox.classList.add('hidden');

            if (code > 3 && code < 45) { desc = "Cloudy"; icon = "https://cdn-icons-png.flaticon.com/512/1163/1163624.png"; }
            else if (code >= 45) { desc = "Rainy"; icon = "https://cdn-icons-png.flaticon.com/512/1163/1163657.png"; alertBox.classList.remove('hidden'); }

            document.getElementById('weatherDesc').innerText = desc;
            document.getElementById('weatherIcon').src = icon;
        }

        window.resetMap = function() {
            document.getElementById('startLocation').value = '';
            document.getElementById('endLocation').value = '';
            document.getElementById('distanceBox').classList.add('hidden');
            document.getElementById('distanceKm').value = '';
            // Hide Weather
            document.getElementById('weatherWidget').classList.remove('visible');

            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeLine) map.removeLayer(routeLine);
            recommendationMarkers.forEach(m => map.removeLayer(m));
            selectionStep = 1;
            map.setView([7.8731, 80.7718], 7);
        }

        function createIcon(color) {
            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }
    });
</script>

</body>
</html>